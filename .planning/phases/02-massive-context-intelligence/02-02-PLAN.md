---
phase: 02-massive-context-intelligence
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - commands/gsd/plan-phase.md
autonomous: true
user_setup: []
must_haves:
  truths:
    - "Planner prompt includes <codebase-intel> section"
    - "Orchestrator calls bin/gsd-context.js"
    - "Plan verification checks for context inclusion"
  artifacts:
    - path: "commands/gsd/plan-phase.md"
      provides: "Updated orchestrator logic"
  key_links:
    - from: "commands/gsd/plan-phase.md"
      to: "bin/gsd-context.js"
      via: "shell execution"
---

<objective>
Integrate the Context Engine into the `gsd:plan-phase` orchestrator. This ensures that every time a phase is planned, the planner agent receives high-quality, graph-aware context about the code it's working on.

Purpose: Fulfill CONTEXT-01 and CONTEXT-02 requirements.
Output: Updated `commands/gsd/plan-phase.md` that spawns the planner with rich context.
</objective>

<execution_context>
@~/.gemini/get-shit-done/workflows/execute-plan.md
@~/.gemini/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-massive-context-intelligence/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update plan-phase.md Context Loading</name>
  <files>commands/gsd/plan-phase.md</files>
  <action>
    Modify `commands/gsd/plan-phase.md` (Step 7: Read Context Files).
    
    Add logic to generate reference context:
    ```bash
    # Generate reference context for the phase
    # (Heuristic: Use the phase directory as a hint, or maybe a key file if known)
    # For now, we might not have a specific target file for the *whole phase*.
    # STRATEGY CHANGE:
    # plan-phase is high level. It needs "summary" context.
    # The REFERENCE context is most useful for *tasks* or specific file planning.
    
    # Requirement Check: "Planner prompts include 'Reference Context' containing full directory listings..."
    # Implementation:
    # 1. Call `node bin/gsd-context.js --summary` (if we add summary mode) 
    # OR 
    # 2. Just rely on `intel/summary.md` which is already read.
    
    # Refinement based on RESEARCH:
    # "Input: targetFile path."
    # The planner plans a PHASE (multiple files).
    
    # NEW STRATEGY:
    # Update `plan-phase.md` to feed `bin/gsd-context.js` with *relevant existing files* found in the phase directory 
    # (e.g., if re-planning or if research identified files).
    
    # Update action:
    # In Step 7, look for research findings or existing plans to identify "focus files".
    # Run `bin/gsd-context.js` on those files.
    # Append output to `INTEL_CONTENT`.
    ```
    
    Actually, to keep it simple for v1:
    Pass a new flag or auto-detect relevant files from `RESEARCH.md` mentions?
    
    Let's stick to the Requirement: "Auto-ingestion of relevant subdirectories".
    
    Update `commands/gsd/plan-phase.md`:
    - In Step 7, run `node bin/gsd-context.js --auto` (we need to implement --auto in Plan 01 or here).
    - Or just inject `intel/summary.md` (already there) AND `intel/graph.db` summary.
    
    Correction: The Requirement `CONTEXT-01` says "Planner prompts include 'Reference Context'".
    The `ReferenceContextBuilder` is built in Plan 01.
    
    We will modify `plan-phase.md` to:
    1. Identify likely target files (maybe from `RESEARCH.md` or just top hotspots).
    2. Call `node bin/gsd-context.js --hotspots` (add this mode to CLI).
    3. Inject output into `<codebase-intel>`.
  </action>
  <verify>
    Run `grep "gsd-context.js" commands/gsd/plan-phase.md`
  </verify>
  <done>Orchestrator script calls the context tool.</done>
</task>

<task type="auto">
  <name>Task 2: Add Hotspots Mode to CLI</name>
  <files>bin/gsd-context.js</files>
  <action>
    Update `bin/gsd-context.js` (created in Plan 01) to support `--hotspots` or `--phase <phase-dir>`.
    
    If `--hotspots`:
    - Query DB for top 5 hotspots.
    - Build context for those 5 files.
    - Return combined XML.
    
    This ensures the planner sees the core of the system.
  </action>
  <verify>
    Run `node bin/gsd-context.js --hotspots`
  </verify>
  <done>CLI supports hotspots mode.</done>
</task>

</tasks>

<verification>
- [ ] `plan-phase.md` modified.
- [ ] `gsd-context.js` supports hotspots.
</verification>

<success_criteria>
- Planner receives rich context automatically.
</success_criteria>

<output>
After completion, create `.planning/phases/02-massive-context-intelligence/02-02-SUMMARY.md`
</output>
