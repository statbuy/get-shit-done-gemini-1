---
id: 05-01
name: Subagent Infrastructure
wave: 1
depends_on: []
files_modified:
  - lib/intel/subagent-host.js
  - lib/intel/subagent-guest.js
  - agents/indexer.js
  - tests/intel/subagent.test.js
autonomous: true
---

# Plan 05-01: Subagent Infrastructure

## Goal
Implement the "Hot Potato" database handoff and process management for delegated analysis. This establishes the communication and data consistency layer between the main CLI process and short-lived analysis subagents.

## Context
Research indicates we must use `child_process.fork` and strict serialization of `sql.js` database access to avoid locking issues and memory bloat. IPC will be handled via JSON Lines logging to avoid event loop blocking.

## Tasks

<task type="file_create" path="lib/intel/subagent-host.js">
<description>
Create the parent-side controller for spawning subagents.
</description>
<requirements>
1.  Function `runSubagent(db, scriptPath, args)` returning `Promise<Database>`.
2.  Implements "Hot Potato" logic:
    - Export DB to disk (`graph.db`) if currently open.
    - Close parent DB instance to release memory/lock (conceptually).
    - Spawn child process (`fork`).
    - Monitor child exit code.
    - Re-initialize parent DB from disk on success.
    - Throw error on non-zero exit.
3.  Monitor a temporary log file for progress updates from child.
</requirements>
</task>

<task type="file_create" path="lib/intel/subagent-guest.js">
<description>
Create the base helper for child processes.
</description>
<requirements>
1.  Function `startSubagent(workCallback)`.
2.  Standardizes startup:
    - Load `sql.js`.
    - Read DB from disk (path passed in args).
    - Initialize DB.
3.  Standardizes shutdown:
    - Export DB to disk.
    - Exit process with 0.
4.  Standardizes logging:
    - `log(level, message, meta)` writes JSON line to log file.
    - Catch global errors and log them before exit 1.
</requirements>
</task>

<task type="file_create" path="agents/indexer.js">
<description>
Create a stub indexer agent to verify the infrastructure.
</description>
<requirements>
1.  Import `startSubagent`.
2.  Implement a no-op or simple metadata update to prove write capability.
3.  Use the standard guest pattern.
</requirements>
</task>

<task type="file_create" path="tests/intel/subagent.test.js">
<description>
Verify the handoff mechanism.
</description>
<requirements>
1.  Test: Parent spawns child -> Child writes row -> Parent sees row.
2.  Test: Child crashes -> Parent recovers (reloads original or handles error).
3.  Test: Concurrent spawns (should be prevented or queued).
</requirements>
</task>

## Verification
- [ ] `node tests/intel/subagent.test.js` passes (ensure test script works standalone or with simple runner).
- [ ] No zombie processes left after test.
- [ ] `graph.db` integrity maintained.

## Must Haves
- Safe DB handoff (Export -> Spawn -> Reload).
- JSON Lines logging visibility.
